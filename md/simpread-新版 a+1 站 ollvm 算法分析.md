> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/GhGtI5_uScZkqKIqGho8yA)

![](https://mmbiz.qpic.cn/mmbiz_png/gY5PqCV2kYZJ4sKUniaZPr7YRoHTLnbM8ZCNohcGM2hjy5tMJyRd9RicbR9HrMkoJiaGrBrV7JjW09zqHtCHI8q8g/640?&wx_fmt=png)

闲来无聊，想看下 b 占安全防护做的如何，于是分析了下新版 b 占的最新版 app，最后把算法弄了出来，虽然相较于原版算法并没有啥改变，但是分析的难度确增加了很多，本文笔者以一个安全研究员的身份来分析下。  

![](https://mmbiz.qpic.cn/mmbiz_png/ib93efMPP0actGbYAbS23TrIXMKA4Hfb3wAjuNLrpnMP1iarC8oTugBZFgEibxVv0uVSvt4F6wwMxoDdCWddEL6sw/640?&wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/zJkrRpjYPhNfP5zichlATibarrJQVsf9t5nNRBIicAoVVXVx4sZ6RgF24KTG4ibkcFX4vyLITzJosTaCZYPD0iaDicrQ/640?&wx_fmt=png)

  

⊙1. 反调试绕过

⊙2. 算法定位

⊙3.ollvm 流程 trace

⊙4.ollvm arm 指令 trace

⊙5. 结果及其彩蛋

1. 反调试绕过

笔者分析在 arm32 位下和 arm64 位下，关于检测 frida 的点

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkt4udOVMPe38aM5bkViaQ3x4XQEHjabklibrkdapDjsh2xxqibtico8JXyw/640?wx_fmt=png)

在 armv8 中对应
-----------

0x1A858

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkBTjKdklNTB6VH1LoYSRpVXTnch94nW6H7zUPmgm5fJV5fw2WMYPSSw/640?wx_fmt=png)

0x1b8b4

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkm0jlwAwKJzbpvicjsFIAQeoHEcXBfhOMicmD3jE1qK1EpFibazGIx9FOg/640?wx_fmt=png)

针对这个两个关键点进行 patch

然后进入 / data/app/tv.danmaku.bili-AK6NWgW6BtysktmJyUc8Ag==/lib/arm64，libmsaoaidsec.so 换成我们 patch 的 so 即可

2. 算法定位

frida-trace -U -j '*!_sign_' -f  tv.**.bili

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkNKV1kogiaAcicPK77724jz9nEMmia00ucK0lj6S70zy0FfKWl9WyibeZHg/640?wx_fmt=png)

发现有那么多的结果，还是光重复一条，根本不适合我们定位算法

frida-trace -U -j '*!_sign_'   -J ‘*!*signal*’   -f tv.

这里经过了好多种试法，终于找到了。。。。

frida-trace -U -j '_?igned_!_'-J'_!_signal_'   -f  tv.

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOksSkVVSwmHITrou6Tf6dibwVtDXx2zKnsicmJENxknz5AY6icqkuX8xlNw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkb7GkhJRkSCU8Z3BkKITr32y63qcqNayWgKCjXhbvDa4XVda8xTJggQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkVQfjnwyAq2awoMnk9SwjTfqZKkKlWLcR0UJD32tEPqicxYzxZbFg2VA/640?wx_fmt=png)

frida-trace -U -j '_LibBili!_'   -f  tv.danmaku.bili

停留在 b 占主页面，然后稍微下滑一点，我们可以看出日志

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkrPWd46atGiatxpUtD2wjIOic3lDicxeY8uHuicNQttLGQZhIBXVNBNaPmA/640?wx_fmt=png)

可以得出每次调用算法的时候，总会拿到 getAppKey 然后去调用  lubBili.s

```
/*
 * Auto-generated by Frida. Please modify to match the signature of LibBili.s.
 *
 * For full API reference, see: https://frida.re/docs/javascript-api/
 */
{
  /**
   * Called synchronously when about to call LibBili.s.
   *
   * @this {object} - The Java class or instance.
   * @param {function} log - Call this function with a string to be presented to the user.
   * @param {array} args - Java method arguments.
   * @param {object} state - Object allowing you to keep state across function calls.
   */
  onEnter(log, args, state) {
    log(`LibBili.s(${args.map(JSON.stringify).join(', ')})`);
    log(args[0].entrySet().toArray())
  },
  /**
   * Called synchronously when about to return from LibBili.s.
   *
   * See onEnter for details.
   *
   * @this {object} - The Java class or instance.
   * @param {function} log - Call this function with a string to be presented to the user.
   * @param {NativePointer} retval - Return value.
   * @param {object} state - Object allowing you to keep state across function calls.
   */
  onLeave(log, retval, state) {
    if (retval !== undefined) {
      log(`<= ${JSON.stringify(retval)}`);
     log("结果"+retval.toString());
    }
  }
}

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkZzzicGw2I5jibt63ygJqCcz6mOvNu9RDwiaIc7nssMWEPRZB0yE3rTqBw/640?wx_fmt=png)

我们多拿几对结果值

```
appkey=1d8b6e7d45233436,build=7320400,c_locale=zh_CN,channel=bili,disable_rcmd=0,mobi_app=android,model=MI 8,platform=android,s_locale=zh_CN,statistics={"appId":1,"platform":3,"version":"7.32.0","abtest":""}
appkey=1d8b6e7d45233436&build=7320400&c_locale=zh_CN&channel=bili&disable_rcmd=0&mobi_app=android&model=MI%208&platform=android&s_locale=zh_CN&statistics=%7B%22appId%22%3A1%2C%22platform%22%3A3%2C%22version%22%3A%227.32.0%22%2C%22abtest%22%3A%22%22%7D&ts=1686105777&sign=5b1ec26ead34e091f6572749262b241d

```

我们在手机上打开评论

```
action=story_comment_click,appkey=1d8b6e7d45233436,build=7320400,c_locale=zh_CN,channel=bili,disable_rcmd=0,extra={"from_spmid":"tm.recommend.0.0","goto":"vertical_av","spmid":"main.ugc-video-detail-vertical.0.0","track_id":"all_42.router-pegasus-1165524-88564bbf7-k59s2.1686105778860.338"},item_id=783291971,item_type=story,mobi_app=android,platform=android,s_locale=zh_CN,statistics={"appId":1,"platform":3,"version":"7.32.0","abtest":""},uid=21837784
action=story_comment_click&appkey=1d8b6e7d45233436&build=7320400&c_locale=zh_CN&channel=bili&disable_rcmd=0&extra=%7B%22from_spmid%22%3A%22tm.recommend.0.0%22%2C%22goto%22%3A%22vertical_av%22%2C%22spmid%22%3A%22main.ugc-video-detail-vertical.0.0%22%2C%22track_id%22%3A%22all_42.router-pegasus-1165524-88564bbf7-k59s2.1686105778860.338%22%7D&item_id=783291971&item_type=story&mobi_app=android&platform=android&s_locale=zh_CN&statistics=%7B%22appId%22%3A1%2C%22platform%22%3A3%2C%22version%22%3A%227.32.0%22%2C%22abtest%22%3A%22%22%7D&ts=1686105979&uid=21837784&sign=1b2cbab0f3db64e63e96ca3bb7dfefa2

```

特征就是输入的都是原始的值，但是输出都进行了编码。

对第一对进行 urldecode

```
appkey=1d8b6e7d45233436,build=7320400,c_locale=zh_CN,channel=bili,disable_rcmd=0,mobi_app=android,model=MI 8,platform=android,s_locale=zh_CN,statistics={"appId":1,"platform":3,"version":"7.32.0","abtest":""}
    appkey=1d8b6e7d45233436&build=7320400&c_locale=zh_CN&channel=bili&disable_rcmd=0&mobi_app=android&model=MI 8&platform=android&s_locale=zh_CN&statistics={"appId":1,"platform":3,"version":"7.32.0","abtest":""}&ts=1686105777&sign=5b1ec26ead34e091f6572749262b241d

```

进行对比，发现增加了 ts 时间戳 和 sign 参数，其他的没有变化。

那去构造个主动调用吧

```
function funsign() {
    Java.perform(function () {
        var TreeMap = Java.use("java.util.TreeMap");
        var map = TreeMap.$new();
        map.put("appkey", "1d8b6e7d45233436");
        map.put("build","7320400");
        var result =Java.use("com.bilibili.nativelibrary.LibBili").s(map);
        console.log("result=>",result.toString());
        return result;
    });
}

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkpEmMibbBmjvAe9pk8jVsEqVfNzZg7GKtENkoUNXfr6GTljCmrZFjUvw/640?wx_fmt=png)

但是我很好奇，每次生成时间戳，那么如果我给她固定时间戳呢，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOk0T55DUhxCGl4SlANJezVBBOgSGb2ArJon1ibzGk4jWNma2dkxCNu6NA/640?wx_fmt=png)

会发现没有变化，那么肯定一个问题，就是输入 + 时间戳  进行加密，不掺杂其他的变量。

但是现在不知道哪个 so 调用，可以使用下方脚本进行测试，

https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_RegisterNatives.js

最终确认加密的 so 在 libili

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkkkibU8GalQ80n7MjobUkiabsiadXU3VVhpicia6lMkyibMjptgaE1fkmMHkw/640?wx_fmt=png)

打开 jni_onload，家人们谁懂啊，上来就是 ollvm

我们上方得到动态注册的函数偏移是 0x9110

进去了一看也是 ollvm，按照我的做法，绝对不会去还原控制流的

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkeRFCo6K3R5QQp3EBt9efnmYYuVAic2alwsuRFHk6pYePGwZJESqMHZg/640?wx_fmt=png)

3.ollvm 流程 trace

然后使用 stalker 得到了程序的执行路径

```
libbili.so!0x194e4 libbili.so!0xc464c -3
libbili.so!0xc4790 libart.so!0x38c380 -2
libbili.so!0xc479c libbili.so!0xb1444 -1
libbili.so!0xb1684 libart.so!0x3de338 0
libbili.so!0x19ca4 libart.so!0x3c450c -1
libbili.so!0x19cb8 libbili.so!0xc3b4c 0
libbili.so!0xc3b7c libbili.so!0xc3990 1
libbili.so!0xc3ac8 libart.so!0x38ac98 2
libbili.so!0xc3b88 libbili.so!0xb1444 2
libbili.so!0xb1684 libart.so!0x3de338 3
libbili.so!0x19950 libart.so!0x3c4ef4 2
libbili.so!0x19960 libbili.so!0x1b0b0 3
libbili.so!0x1be20 libbili.so!0x82a0 4
libbili.so!0x19e54 libbili.so!0x1a884 3
libbili.so!0x1a998 libart.so!0x3c450c 4
libbili.so!0x1a9ac libbili.so!0xc3b4c 5
libbili.so!0xc3b7c libbili.so!0xc3990 6
libbili.so!0xc3ac8 libart.so!0x38ac98 7
libbili.so!0xc3b88 libbili.so!0xb1444 7
libbili.so!0xb1684 libart.so!0x3de338 8
libbili.so!0x1ab00 libbili.so!0xb2634 7
libbili.so!0xb2778 libart.so!0x386ea8 8
libbili.so!0x1ab0c libbili.so!0xb2634 8
libbili.so!0xb2778 libart.so!0x386ea8 9
libbili.so!0x19e68 libbili.so!0x1ab44 8
libbili.so!0x1ab98 libart.so!0x3ae4dc 9
libbili.so!0x1acac libbili.so!0xb1118 10
libbili.so!0xb12fc libart.so!0x3de338 11
libbili.so!0x19e84 libart.so!0x3c4ef4 10
libbili.so!0x19f60 libart.so!0x3c548c 11
libbili.so!0x19f68 libbili.so!0x8390 12
libbili.so!0x19ae0 libbili.so!0x8320 12
libbili.so!0x19af4 libbili.so!0x1c000 12
libbili.so!0x1c07c libbili.so!0x83c0 13
libbili.so!0x1c084 libbili.so!0xfb28 13
libbili.so!0x1c094 libbili.so!0xfb3c 13
libbili.so!0x10224 libbili.so!0x83a0 14
libbili.so!0x1c104 libbili.so!0x82c0 13
libbili.so!0x1c114 libbili.so!0xfb3c 13
libbili.so!0x10224 libbili.so!0x83a0 14
libbili.so!0x1c104 libbili.so!0x82c0 13
libbili.so!0x1c114 libbili.so!0xfb3c 13
libbili.so!0x100d4 libbili.so!0x83a0 14
libbili.so!0x100e4 libbili.so!0x11384 14
libbili.so!0x135f4 libbili.so!0x15e44 15
libbili.so!0x10224 libbili.so!0x83a0 14
libbili.so!0x1c104 libbili.so!0x82c0 13
libbili.so!0x1c114 libbili.so!0xfb3c 13
libbili.so!0x10224 libbili.so!0x83a0 14
libbili.so!0x1c104 libbili.so!0x82c0 13
libbili.so!0x1c114 libbili.so!0xfb3c 13
libbili.so!0x10224 libbili.so!0x83a0 14
libbili.so!0x1c410 libbili.so!0x15a6c 13
libbili.so!0x15aa0 libbili.so!0x15b30 14
libbili.so!0x15ad4 libbili.so!0xfb3c 14
libbili.so!0x10224 libbili.so!0x83a0 15
libbili.so!0x15ae4 libbili.so!0xfb3c 14
libbili.so!0x100d4 libbili.so!0x83a0 15
libbili.so!0x100e4 libbili.so!0x11384 15
libbili.so!0x135f4 libbili.so!0x15e44 16
libbili.so!0x10224 libbili.so!0x83a0 15
libbili.so!0x15af4 libbili.so!0x15b30 14
libbili.so!0x15b04 libbili.so!0x83c0 14
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x1c444 libbili.so!0x82c0 13
libbili.so!0x19afc libbili.so!0x8410 12
libbili.so!0x19b10 libart.so!0x3c450c 12
libbili.so!0x19c28 libbili.so!0xb2634 13
libbili.so!0xb2778 libart.so!0x386ea8 14
libbili.so!0x1a050 libart.so!0x388b7c 14

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkOLlkibQShCegaAYIF7SI4ficP64A26VfrIu6KA4ydBbCArSUHxWcGseA/640?wx_fmt=png)

这个时候我们看 v6 的交叉引用是 env，v70 的交叉引用是 上方的 a2

j 经过一阵很长的分析，发现，，，没啥发现，函数太多了，还是直接 trace 指令吧

4.ollvm arm 指令 trace

用 stalker 写了个脚本，去 trace 了下指令  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkLKDSQ4zvib057T5jfRYqMDqHqAic5ibu4dgcIXEKpDIKlD7RVMR2tibibog/640?wx_fmt=png)

因为 trace 的结果是 appkey=1d8b6e7d45233436&build=7320400&ts=1686106983&sign=e66bbde177f4978281656f64b62c696d

sign 为 32 位盲猜 md5，  首先 b62c696d，把最后四个字节拿出来，转换一下端序为 0x6d692cb6

那么就在 trace 文件中进行搜索

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOk2JDvkJMyIfpvsTPA8jhc48RukBzLjyA7wEUfuicwlHQvVgvooJc0F6w/640?wx_fmt=png)

有四个结果，我们可以去看四个结果调用的偏移在 ida 的那个函数，其实就是根据这四个，然后去 ida 中定位

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkmiccsnkcpj4AkdjicWKT56HtTpb0dwuVkeYlVbkXSFkgIE8tPG81MsAA/640?wx_fmt=png)

```
function funsign() {
    Java.perform(function () {
        var TreeMap = Java.use("java.util.TreeMap");
        var treemap = TreeMap.$new();
        treemap.put("appkey", "1d8b6e7d45233436");
        treemap.put("build","7320400");
        treemap.put("ts","1686106983");
        var result =Java.use("com.bilibili.nativelibrary.LibBili").s(treemap);
        console.log("result=>",result);
        return result;
    });
}
function  hook_1(){
    let base_bili = Module.findBaseAddress("libbili.so");
let sub_19024 = base_bili.add(0x11384);
Interceptor.attach(sub_19024 , {
    onEnter(args) {
        console.log(hexdump(args[0]))
        console.log(hexdump(args[1]));
         console.log(hexdump(args[2]));
        //console.log(args[1])
    }, onLeave(retval) {
        console.log(retval)
        console.log("end-hook-------------")
    }
})
}

```

5. 结果及其彩蛋

![](https://mmbiz.qpic.cn/sz_mmbiz_png/p5YHVYUwZib33TZLxaYBSoe96TMiccbrOkTEySGpSDBHQ1hvMfj1V7kOrZIhSIbSn1pra6rSeuXBSU2rcjnj72yQ/640?wx_fmt=png)

ios 我也搞了下，更简单就不记录了  

appkey:27eb53fc9058f8c3, 2ed53a74eeefe3cf99fbd01d8c9c375 是 salt

如果想要获得更多精彩内容可以关注我朋友:  

我是 BestToYou, 分享工作或日常学习中关于 Android、iOS 逆向及安全防护的一些思路和一些自己闲暇时刻调试的一些程序, 文中若有错误或者不足的地方, 恳请大家联系我批评指正。

![](https://mmbiz.qpic.cn/mmbiz_jpg/p5YHVYUwZib1LXXkvk6YVoJQJ90OVr4VIkII5veh8SKAFHibZFGiazq7ic7DWSfeTLl6Usp0GMANicVMvC5U0hKkDDg/640?wx_fmt=jpeg)

扫码加我为好友